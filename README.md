# Golos Auth & Registration Service

Сервис регистрации и серверной авторизации для проектов на блокчейне Golos Blockchain.
- [Web-интерфейс](https://auth.golos.today/register), позволяющий пользователям регистрировать свои аккаунты в Golos, и поддерживающий кастомизацию в стиле вашего проекта.
- Либо же, благодаря открытому коду, вы можете развернуть свою собственную, полностью кастомизированную, копию сервиса.
- Также есть API, позволяющее вам создать с нуля свой собственный сервис регистрации и\или серверной авторизации в Golos, но не тратить время на реализацию самого backend-функционала, а полностью посвятить себя дизайну UI/UX и добиться превосходного результата.
- Серверная авторизация, которую могут использовать ваши сервисы и микросервисы, в том случае, если нужно на стороне back-end авторизовывать аккаунты (однако в большинстве случаев этого делать не нужно, следует использовать [клиентскую авторизацию](https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md)).

## Кастомизация

Если вы разрабатываете приложение на платформе Golos, то в нем должна быть возможность регистрировать пользователей, как и в обычном приложении или сайте.
Вам не нужно делать свою собственную страницу регистрации и даже поднимать свою копию Golos Auth Service.
Сообщество Golos Blockchain само кастомизирует для вас уже имеющуюся cтраницу https://auth.golos.today/register, чтобы органично вписать ее в ваш клиент: дизайн, логотип, язык интерфейса и др.

Пример кастомизации в восхитительных фиолетовых тонах:
https://auth.golos.today/prizmtalk/register

Для кастомизации нам необходимо следующее:
1. Название вашего приложения и идентификатор, который вы хотите видеть в URL. В данном примере это "prizmtalk".
2. Таблицу стилей CSS, которую нужно добавить для кастомизации ([пример](https://devauth.golos.today/themes/prizmtalk/theme.css)). Кастомизировать можно абсолютно любой элемент страницы.
3. Логотип в любом удобном формате, в том числе анимированный.
4. Если сервис англоязычный, укажите это, и мы сделаем, что по умолчанию будет открываться английская версия страницы. Можем добавить и другие языки.

## Разворачивание своей копии сервиса

### Сборка

Сервису требуются [Docker](https://docs.docker.com/engine/install/) и [Docker-Compose](https://docs.docker.com/compose/install/).

```bash
docker-compose build
```

### Запуск

```bash
docker-compose up
```

## API для разработчиков

Все запросы и ответы имеют формат объекта JSON.

### Обработка ошибок

В случае успеха все ответы содержат поле `"status": "ok"`, в случае ошибки - `"status": "err"` и поля с исчерпывающей информацией об ошибке (описаны ниже по тексту).

При ошибке запрос имеет один из следующих HTTP-статусов:
- 429 (слишком много запросов с вашего IP),
- 404 (неверный маршрут),
- 405 (неверный метод запроса),
- 500 (внутренняя ошибка сервера),
- 503 (недоступен сервис или отдельная возможность, например отключена регистрация через e-mail), 
- 400 (любые другие ошибки).
HTTP-статус дублируется также в поле `"httpStatus"`, на тот случае, если ваш HTTP-клиент не может прочитать стандартный HTTP-статус ответа.

При регистрации есть дополнительные возможности для более удобной и легкой обработки ошибок. Они описаны в соответствующей главе.

### Серверная авторизация

**Примечание:** Для авторизации ваш клиент, использующий сервис, должен быть в белом списке сервиса. Для использования API в своем клиенте следует обратиться к сообществу с целью добавления вашего клиента (его доменного имени) в этот список, или же развернуть свою копию данного сервиса.

Хранение состояния авторизации осуществляется в заголовке `X-Auth-Session` (который играет роль cookies), поэтому при каждом запросе следует сохранять в localStorage значение данного заголовка ответа (но если заголовка в ответе нет, то очищать НЕ следует), а при каждом запросе добавлять сохраненное значение к запросу.

Примеры работы с API (используя Fetch и async-await) можно найти в тестах:  
https://github.com/golos-blockchain/ui-auth/blob/dev/cypress/integration/login.spec.js  
https://github.com/golos-blockchain/ui-auth/blob/dev/cypress/support/index.js  

##### `POST /login_account` - авторизация аккаунта пользователя.

Для того, чтобы пользователь мог получать большинство уведомлений, ему нужно будет авторизоваться в вашем клиенте, используя для этого данный маршрут API.

Авторизация осуществляется в 2 этапа.

Этап 1. Сделать POST-запрос с телом `{"account": "имя аккаунта"}`, в ответе будут поля:
- `login_challenge` - рандомная строка, необходимая для этапа 2
- `already_authorized` - если какой-то аккаунт с данным X-Session уже авторизован, то содержит имя этого аккаунта.

Этап 2. Подписать `login_challenge` posting-ключом аккаунта (а если авторизация происходит по паролю, то сперва извлечь из пароля posting-ключ), и отправить новый POST-запрос: `{"account": "имя аккаунта", "signatures": {"posting":"<подпись>"}}`.

##### `GET /logout_account` - выход из аккаунта пользователя.

В случае, если аккаунт и не был авторизован, ошибки НЕ выдает. Возвращает ответ с полем `was_logged_in`, которое равно `true`, если аккаунт действительно был авторизован.

### Регистрация 

#### Обработка ошибок

При обработке ошибок не обязательно формировать человекопонятные сообщения для вывода в UI. API делает эту работу за вас. При ошибке ответ содержит поле `"error_str"`. В нем - уже готовое, локализованное сообщение об ошибке, на том языке (RU или EN), который был вами задан ранее (см. Инициализация клиента). Например: `E-mail должен принадлежать Google Mail (gmail.com).`.

Но на случай, если вас такой вариант не устроит, имеется также поле `"error"` - технический идентификатор ошибки, например: `wrong_mail_service`, `Internal Server Error`.

#### Инициализация клиента

##### `GET /api/reg/get_uid` - инициализация.

Необходимо выполнить перед всеми дальнейшими манипуляциями с API регистрации. Сохраняет cookie с сессией.

##### `GET /api/reg/set_locale/:locale` - задать локаль для сообщений об ошибках.

`:locale` - ru или en.

#### Регистрация с помощью Google e-mail

##### `POST /api/reg/send_code`

Отправляет код подтвержденния на заданный e-mail, который **обязательно** должен принадлежать Google (@gmail.com, @google.com).
Пример запроса:
```json
{
    "email": "test@gmail.com"
}
```

##### `POST /api/reg/verify_code`

Проверяет введенный пользователем код подтверждения, и в случае успеха сохраняет в сессию cookies данные, позволяющие сделать запрос на само создание аккаунта. 
Пример запроса:
```json
{
    "email": "test@gmail.com",
    "confirmation_code": "1234"
}
```

#### Регистрация с помощью инвайт-кода

##### `POST /api/reg/use_invite`

Пример запроса:
```json
{
    "invite_key": "5J..."
}
```

#### Регистрация с помощью социальных сетей

Вместо Google e-mail и инвайт-кода можно подтвердить свою личность с помощью одной из социальных сетей.
Список поддерживаемых соцсетей находится [здесь](https://github.com/golos-blockchain/ui-auth/blob/master/config/default.json#L108).
Рассмотрим регистрацию на примере ВКонтакте.

Для регистрации с помощью ВКонтакте следует открыть **новую вкладку** с этим URL:

##### `GET /api/reg/modal/vk`

Пример:
```js
window.open(`https://auth.golos.today/api/reg/modal/vk`, '_blank');
```

При успешной авторизации вкладка закроется автоматически.

А клиент может отследить этот момент с помощью следующего запроса:

##### `GET /api/reg/check_soc_auth`

Этот запрос следует повторять не чаще, чем раз в 5 секунд, пока в ответе `"step"` не станет `'verified'`.

#### Создание аккаунта

Перед созданием аккаунта пользователю необходимо:
- пройти верификацию (e-mail, инвайт-код или социальная сеть. Описано выше);
- ввести капчу Recaptcha v2.

##### `GET /api/reg/get_captchas`

Позволяет получить site_key нашей Recaptcha, что позволит вам разместить ее на странице, так же, как ее размещают на своем сайте.

##### `POST /api/reg/submit`

Пример запроса:
```json
{
    "invite_code": "5J...",
    "referrer": "cyberfounder",
    "email": "test@gmail.com",
    "name": "novoreg",
    "owner_key": "GLS...",
    "active_key": "GLS...",
    "posting_key": "GLS...",
    "memo_key": "",
    "recaptcha_v2": "03A..."
}
```

- `owner_key`, `active_key`, `posting_key`, `memo_key` - это **публичные** ключи. Вам не нужно передавать сервису приватные ключи аккаунта. Так что сервис полностью безопасен.
- Генерация ключей происходит на клиенте. Для этого можно использовать [golos.auth.generateKeys()](https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md#генерация-ключей) из библиотеки [golos-lib-js](https://www.npmjs.com/package/golos-lib-js).
- Не указывайте `invite_code`, если регистрируете аккаунт без инвайт-кода (подтвержденный через e-mail или социальную сеть).
- `referrer` - это имя аккаунта, который будет получать реферальные выплаты с зарегистрированного аккаунта. Можно не указывать.

#### Утилиты для регистрации

##### `GET /api/utils/account_exists/:name`

##### `GET /api/utils/get_account/:name`

##### `GET /api/utils/get_invite/:public_key`

