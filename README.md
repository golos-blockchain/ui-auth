# Golos Auth & Registration Service

Сервис регистрации и серверной авторизации для проектов на блокчейне Golos Blockchain.
- [Web-интерфейс](https://auth.golos.today/register), позволяющий пользователям регистрировать свои аккаунты в Golos, и поддерживающий кастомизацию в стиле вашего проекта.
- Либо же, благодаря открытому коду, вы можете развернуть свою собственную, полностью кастомизированную, копию сервиса.
- Также есть API, позволяющее вам создать с нуля свой собственный сервис регистрации и\или серверной авторизации в Golos, но не тратить время на реализацию самого backend-функционала, а полностью посвятить себя дизайну UI/UX и добиться превосходного результата.
- Серверная авторизация, которую могут использовать ваши сервисы и микросервисы, в том случае, если нужно на стороне back-end авторизовывать аккаунты (однако в большинстве случаев этого делать не нужно, следует использовать [клиентскую авторизацию](https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md)).

## Разворачивание своей копии сервиса

### Сборка

Сервису требуются [Docker](https://docs.docker.com/engine/install/) и [Docker-Compose](https://docs.docker.com/compose/install/).

```bash
docker-compose build
```

### Запуск

```bash
docker-compose up
```

## API для разработчиков

Все запросы и ответы имеют формат JSON.
В случае успеха все запросы возвращают объект, содержащий поле `"status": "ok"`, а в случае ошибки - `"status": "err"`, поле `error`, содержащее текст ошибки, и HTTP-статус ошибки:
- 429 (слишком много запросов с вашего IP),
- 404 (неверный маршрут или метод запроса),
- 500 (внутренняя ошибка сервера),
- 400 (любые другие ошибки).

**Примечание:** Большинство запросов API требуют авторизацию аккаунтов в сервисе. Для авторизации ваш клиент, использующий сервис, должен быть в белом списке сервиса. Для использования API в своем клиенте следует обратиться к сообществу с целью добавления вашего клиента (его доменного имени) в этот список, или же развернуть свою копию данного сервиса.

Хранение состояния авторизации осуществляется в заголовке `X-Auth-Session` (который играет роль cookies), поэтому при каждом запросе следует сохранять в localStorage значение данного заголовка ответа (но если заголовка в ответе нет, то очищать НЕ следует), а при каждом запросе добавлять сохраненное значение к запросу.

### Серверная авторизация

Примеры работы с API (используя Fetch и async-await) можно найти в тестах:  
https://github.com/golos-blockchain/ui-auth/blob/dev/cypress/integration/login.spec.js  
https://github.com/golos-blockchain/ui-auth/blob/dev/cypress/support/index.js  

#### `POST /login_account` - авторизация аккаунта пользователя.

Для того, чтобы пользователь мог получать большинство уведомлений, ему нужно будет авторизоваться в вашем клиенте, используя для этого данный маршрут API.

Авторизация осуществляется в 2 этапа.

Этап 1. Сделать POST-запрос с телом `{"account": "имя аккаунта"}`, в ответе будут поля:
- `login_challenge` - рандомная строка, необходимая для этапа 2
- `already_authorized` - если какой-то аккаунт с данным X-Session уже авторизован, то содержит имя этого аккаунта.

Этап 2. Подписать `login_challenge` posting-ключом аккаунта (а если авторизация происходит по паролю, то сперва извлечь из пароля posting-ключ), и отправить новый POST-запрос: `{"account": "имя аккаунта", "signatures": {"posting":"<подпись>"}}`.

#### `GET /logout_account` - выход из аккаунта пользователя.

В случае, если аккаунт и не был авторизован, ошибки НЕ выдает. Возвращает ответ с полем `was_logged_in`, которое равно `true`, если аккаунт действительно был авторизован.
