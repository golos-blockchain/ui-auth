# API для разработчиков

Все запросы и ответы имеют формат объекта JSON.  
Работать с API можно с помощью [fetch](https://developer.mozilla.org/ru/docs/Web/API/Fetch_API) или любой сторонней библиотеки для HTTP.  
При регистрации аккаунта пользователь обязательно должен пройти **ReCaptcha v2**. Нужно встроить ее в свою страницу, получить response капчи и отправить его в API при создании аккаунта. Подробнее смотрите в [документации ReCaptcha](https://developers.google.com/recaptcha/docs/display)). Удобнее всего встраивать ReCaptcha с помощью какого-то готового компонента.  
Кроме того, для использования серверной авторизации вы должны обратиться к сообществу, чтобы оно добавило ваш хост в разрешенные ([подробнее](#серверная-авторизация)). Для регистрации это не требуется.

- [Обработка ошибок](#обработка-ошибок)
- [Авторизация OAuth](#авторизация-oauth) (рекомендуется)
- [Серверная авторизация](#серверная-авторизация)
- [Регистрация аккаунтов](#регистрация) (вы можете создать свою страницу регистрации и API будет готовым бек-ендом для нее)
    - [Обработка ошибок](#обработка-ошибок-1)
    - [Инициализация клиента](#инициализация-клиента)
    - [Регистрация с помощью Google e-mail](#регистрация-с-помощью-google-e-mail)
    - [Регистрация с помощью инвайт-кода](#регистрация-с-помощью-инвайт-кода)
    - [Регистрация с помощью социальных сетей](#регистрация-с-помощью-социальных-сетей)
    - [Создание аккаунта](#создание-аккаунта)
    - [Утилиты для валидации полей на странице регистрации](#утилиты-для-валидации-полей-на-странице-регистрации)

## Обработка ошибок

В случае успеха все ответы содержат поле `"status": "ok"`, в случае ошибки - `"status": "err"` и поля с исчерпывающей информацией об ошибке (описаны ниже по тексту).

При ошибке запрос имеет один из следующих HTTP-статусов:
- 429 (слишком много запросов с вашего IP),
- 404 (неверный маршрут),
- 405 (неверный метод запроса),
- 500 (внутренняя ошибка сервера),
- 503 (недоступен сервис или отдельная возможность, например отключена регистрация через e-mail), 
- 400 (любые другие ошибки).
HTTP-статус дублируется также в поле `"httpStatus"`, на тот случае, если ваш HTTP-клиент не может прочитать стандартный HTTP-статус ответа.

При регистрации есть дополнительные возможности для более удобной и легкой обработки ошибок. Они описаны в соответствующей главе.

## Авторизация OAuth

Если вы недавно начали создавать сервисы на платформе Golos Blockchain, то пользователи могут бояться вводить в вашем приложении posting-ключи от своих аккаунтов, и тем более active-ключи и пароли. Поэтому непосредственное взаимодействие с [нодами БЧ Golos](https://github.com/golos-blockchain/libs/tree/master/golos-lib-js#%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB%D1%8B-websockets-%D0%B8-http) будет сомнительным решением.

Рекомендуется использовать сервис Golos Auth & Registration Service. Он является своеобразной оберткой для нод БЧ Golos, так что вы можете отправлять на него транзакции, но пользователю при этом не придется вводить ключ или пароль в вашем приложении.

**Вот примеры, как использовать OAuth в приложениях на jQuery или React:**  
https://github.com/golos-blockchain/ui-auth/tree/examples/

**Но прежде чем начать работу**, вам необходимо обратиться к нашему сообществу для добавления вашего клиента (т.е. приложения, сайта) в список Golos Auth & Registration Service. Необходимо предоставить:
- идентификатор клиента (например: hotdog-website)
- название клиента на русском (например: Блоги про хот-доги)
- описание клиента на русском (например: Как готовить хот-доги, где взять вкусную сосиску и булочку, как выбрать готовый хот-дог...)
- название клиента на английском
- описание клиента на английском
- логотип, желательно квадратный, в идеале размерами 128x128.

Все эти данные мы будем показывать пользователю при авторизации в вашем приложении, чтобы он видел, какому приложению разрешает доступ.

При этом учитывайте, что для серверной авторизации у нас другой, отдельный список клиентов, а для регистрации (если используется кастомизированный дизайн) - третий. Если вам понадобятся и эти возможности, то укажите это в своем сообщении, чтобы мы сразу добавили ваш клиент во все списки.

### Настройка golos-lib-js для OAuth

```js
const API_HOST = 'golos.app';

golos.config.set('oauth.client', 'hotdog-website');
golos.config.set('oauth.host', API_HOST);
golos.config.set('websocket', API_HOST + '/api/oauth/sign');
golos.config.set('credentials', 'include');
golos.use(new golos.middlewares.OAuthMiddleware());
```

- oauth.host - адрес Golos Auth & Registration Service. Используйте **golos.app** для основной сети Golos, или **dev.golos.app** для тестовой сети.
- oauth.client - идентификатор клиента (см. выше).
- websocket - адрес, на который будут приходить запросы от golos-lib-js (обертка для БЧ Golos)
- credentials = include - это настройка нужна для того, чтобы браузер мог отправлять cookies при этих запросах (при работе с нодами напрямую cookies не используются).

### Отправка запросов к API

Осуществляется так же, как и напрямую с нодами, и не требует авторизации (все запросы на получение данных работают и до того, как пользователь авторизуется в вашем приложении с помощью OAuth).

### Авторизация

Для авторизации необходимо открыть отдельную вкладку с адресом вида golos.app/oauth/hotdog-website.

О том, как это делать в случае браузерного приложения\сайта, здесь:
https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md

Теоретически подобная авторизация возможна и в мобильном приложении (нужно открывать экраном с браузерным компонентом, после авторизации забирать cookie и использовать их при дальнейших запросах к сервису).

### Серверный токен авторизации

На серверной стороне также есть возможность убедиться, что пользователь авторизован в вашем клиенте.
Алгоритм действий в этом случае таков:
- авторизоваться в браузере, как обычно, при помощи `golos.oauth.waitForLogin` и  `golos.oauth.checkReliable` ([подробнее](https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md)). Эти функции возвращают значение - JSON-объект, в котором есть поле `server_token`. Передайте этот токен на ваш сервер. При этом не заботьтесь о том, что злоумышленник может тоже передать на ваш сервер вымышленный токен - ведь проверка будет на вашем сервере.
- собственно проверьте токен на вашем сервере, используя маршрут `/api/oauth/check_server_token`.
- при выходе пользователя из вашего приложения или системы OAuth вообще, токен недействителен. `/api/oauth/check_server_token` больше не считает его корректным, и со стороны браузера `waitForLogin/checkReliable` также не выдают `server_token`.

#### `GET /api/oauth/check_server_token/:server_token` - проверка серверного токена.

Как было сказано выше, запрос этот следует делать со стороны вашего сервера, чтобы проверить серверный токен. Использовать любую HTTP-библиотеку, например, axios. Ничего дополнительного не требуется, просто GET-запрос на https://golos.app с проверяемым токеном вместо `:server_token`.

Если токен действителен, то ответ (JSON-объект) содержит:
- поле `account` - какой аккаунт "создал" этот токен
- поле `client` - в каком приложении авторизовался пользователь с этим токеном

Проверяйте эти поля, чтобы убедиться, что токен именно от вашего приложения\сайта.

Если же такого токена вообще нет, то JSON не содержит этих полей.

Блокчейн при этом не задействован, так что запрос мало нагружает наш сервер.

### Отправка операций

После успешной авторизации отправлять операции вообще без подписи. Сервис сам подпишет их.

О том, как это делать в случае браузерного приложения\сайта, здесь:
https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md#отправка-операций

## Серверная авторизация

**Примечание:** Для авторизации ваш клиент, использующий сервис, должен быть в белом списке сервиса. Для использования API в своем клиенте следует обратиться к сообществу с целью добавления вашего клиента (его доменного имени) в этот список, или же развернуть свою копию данного сервиса.

Хранение состояния авторизации осуществляется в заголовке `X-Auth-Session` (который играет роль cookies), поэтому при каждом запросе следует сохранять в localStorage значение данного заголовка ответа (но если заголовка в ответе нет, то очищать НЕ следует), а при каждом запросе добавлять сохраненное значение к запросу.

Примеры работы с API (используя Fetch и async-await) можно найти в тестах:  
https://github.com/golos-blockchain/ui-auth/blob/master/cypress/integration/login.spec.js  
https://github.com/golos-blockchain/ui-auth/blob/master/cypress/support/index.js  

#### `POST /login_account` - авторизация аккаунта пользователя.

Для того, чтобы пользователь мог получать большинство уведомлений, ему нужно будет авторизоваться в вашем клиенте, используя для этого данный маршрут API.

Авторизация осуществляется в 2 этапа.

Этап 1. Сделать POST-запрос с телом `{"account": "имя аккаунта"}`, в ответе будут поля:
- `login_challenge` - рандомная строка, необходимая для этапа 2
- `already_authorized` - если какой-то аккаунт с данным X-Session уже авторизован, то содержит имя этого аккаунта.

Этап 2. Подписать `login_challenge` posting-ключом аккаунта (а если авторизация происходит по паролю, то сперва извлечь из пароля posting-ключ), и отправить новый POST-запрос: `{"account": "имя аккаунта", "signatures": {"posting":"<подпись>"}}`.

Для подписи есть [специальная функция](https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md#%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%BD%D0%B0%D1%8F-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F) в golos-lib-js.

#### `GET /logout_account` - выход из аккаунта пользователя.

В случае, если аккаунт и не был авторизован, ошибки НЕ выдает. Возвращает ответ с полем `was_logged_in`, которое равно `true`, если аккаунт действительно был авторизован.

#### Проверка на вашем сервере, что аккаунт авторизован

У нас по такому принципу работает авторизация в Golos Notify Service (написано на Koa, использует библиотеку axios, но можно использовать любой другой способ отправлять HTTP-запросы из Node.js):
https://github.com/golos-blockchain/notify/blob/master/dataserver/api/auth.js

## Регистрация 

Примером работы с API служит UI нашего же сервиса (используется Fetch и async-await, UI на React, для ReCaptcha используется https://www.npmjs.com/package/react-google-recaptcha):
https://github.com/golos-blockchain/ui-auth/blob/master/src/pages/register/%5B%5B...client%5D%5D.jsx

### Обработка ошибок

При обработке ошибок не обязательно формировать человекопонятные сообщения для вывода в UI. API делает эту работу за вас. При ошибке ответ содержит поле `"error_str"`. В нем - уже готовое, локализованное сообщение об ошибке, на том языке (RU или EN), который был вами задан ранее (см. Инициализация клиента). Например: `E-mail должен принадлежать Google Mail (gmail.com).`.

Но на случай, если вас такой вариант не устроит, имеется также поле `"error"` - технический идентификатор ошибки, например: `wrong_mail_service`, `Internal Server Error`.

### Инициализация клиента

##### `GET /api/reg/get_uid` - инициализация.

Необходимо выполнить перед всеми дальнейшими манипуляциями с API регистрации. Сохраняет cookie с сессией.

##### `GET /api/reg/set_locale/:locale` - задать локаль для сообщений об ошибках.

`:locale` - ru или en.

### Регистрация с помощью Google e-mail

#### `POST /api/reg/send_code`

Отправляет код подтвержденния на заданный e-mail, который **обязательно** должен принадлежать Google (@gmail.com, @google.com).
Пример запроса:
```json
{
    "email": "test@gmail.com"
}
```

#### `POST /api/reg/verify_code`

Проверяет введенный пользователем код подтверждения, и в случае успеха сохраняет в сессию cookies данные, позволяющие сделать запрос на само создание аккаунта. 
Пример запроса:
```json
{
    "email": "test@gmail.com",
    "confirmation_code": "1234"
}
```

### Регистрация с помощью инвайт-кода

#### `POST /api/reg/use_invite`

Пример запроса:
```json
{
    "invite_key": "5J..."
}
```

### Регистрация с помощью социальных сетей

Вместо Google e-mail и инвайт-кода можно подтвердить свою личность с помощью одной из социальных сетей.
Список поддерживаемых соцсетей находится [здесь](https://github.com/golos-blockchain/ui-auth/blob/master/config/default.json#L108).
Рассмотрим регистрацию на примере ВКонтакте.

Для регистрации с помощью ВКонтакте следует открыть **новую вкладку** с этим URL:

#### `GET /api/reg/modal/vk`

Пример:
```js
window.open(`https://golos.app/api/reg/modal/vk`, '_blank');
```

При успешной авторизации вкладка закроется автоматически.

А клиент может отследить этот момент с помощью следующего запроса:

#### `GET /api/reg/check_soc_auth`

Этот запрос следует повторять не чаще, чем раз в 5 секунд, пока в ответе `"step"` не станет `'verified'`.

### Создание аккаунта

Перед созданием аккаунта пользователю необходимо:
- пройти верификацию (e-mail, инвайт-код или социальная сеть. Описано выше);
- ввести капчу Recaptcha v2.

#### `GET /api/reg/get_captchas`

Позволяет получить site_key нашей Recaptcha, что позволит вам разместить ее на странице, так же, как ее размещают на своем сайте.

#### `POST /api/reg/submit`

Пример запроса:
```json
{
    "invite_code": "5J...",
    "referrer": "cyberfounder",
    "email": "test@gmail.com",
    "name": "novoreg",
    "owner_key": "GLS...",
    "active_key": "GLS...",
    "posting_key": "GLS...",
    "memo_key": "",
    "recaptcha_v2": "03A..."
}
```

- `owner_key`, `active_key`, `posting_key`, `memo_key` - это **публичные** ключи. Вам не нужно передавать сервису приватные ключи аккаунта. Так что сервис полностью безопасен.
- Генерация ключей происходит на клиенте. Для этого можно использовать [golos.auth.generateKeys()](https://github.com/golos-blockchain/libs/blob/master/golos-lib-js/docs/files/auth.md#генерация-ключей) из библиотеки [golos-lib-js](https://www.npmjs.com/package/golos-lib-js).
- Не указывайте `invite_code`, если регистрируете аккаунт без инвайт-кода (подтвержденный через e-mail или социальную сеть).
- `referrer` - это имя аккаунта, который будет получать реферальные выплаты с зарегистрированного аккаунта. Можно не указывать.

### Утилиты для валидации полей на странице регистрации

#### `GET /api/utils/account_exists/:name`

#### `GET /api/utils/get_account/:name`

#### `GET /api/utils/get_invite/:public_key`
